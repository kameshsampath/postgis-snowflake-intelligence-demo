# Database Initialization Scripts

This directory contains SQL scripts that initialize the PostgreSQL/PostGIS database for the Street Lights Maintenance system. These scripts run automatically when the Docker container starts for the first time.

> [!CAUTION]
> **DISCLAIMER**: All data generated by this system is fictitious and created solely for demonstration and educational purposes. Company names, contact information, and other identifiers are computer-generated and do not represent real entities.

## üìã Execution Order

The scripts execute in alphabetical order (01, 02, 03, etc.):

1. `01_enable_extensions.sql` - Enable PostGIS extensions
2. `02_enable_wal.sql` - Configure Write-Ahead Logging for CDC
3. `03_create_base_tables.sql` - Create operational tables
4. `04_create_enrichment_tables.sql` - Create enrichment tables
5. `05_create_enriched_views.sql` - Create combined views
6. `06_create_indexes.sql` - Create spatial and B-tree indexes
7. `07_create_replication_slots.sql` - Create replication slot for CDC

---

## üóÇÔ∏è Database Schema

### Base Tables (Operational Data)

#### 1. `neighborhoods`

Geographic boundaries and metadata for city neighborhoods.

| Column | Type | Description |
|--------|------|-------------|
| `neighborhood_id` | TEXT | Primary key, unique identifier (e.g., "NBH-001") |
| `name` | TEXT | Neighborhood name (e.g., "Koramangala") |
| `boundary` | GEOMETRY(Polygon, 4326) | Polygon boundary in WGS84 coordinates |
| `population` | INTEGER | Total population in neighborhood |
| `created_at` | TIMESTAMP | Record creation timestamp |

**Spatial Type**: `GEOMETRY(Polygon, 4326)`

- **Polygon**: A closed shape defined by a series of points
- **SRID 4326**: World Geodetic System 1984 (WGS84) - standard GPS coordinates (latitude/longitude)

---

#### 2. `street_lights`

Operational data for all street lights in the system.

| Column | Type | Description |
|--------|------|-------------|
| `light_id` | TEXT | Primary key, unique identifier (e.g., "LIGHT-0001") |
| `location` | GEOMETRY(Point, 4326) | GPS coordinates (longitude, latitude) |
| `status` | TEXT | Current status: 'operational', 'faulty', 'maintenance_required' |
| `wattage` | INTEGER | Light wattage (e.g., 100, 150, 200) |
| `installation_date` | DATE | Date light was installed |
| `last_maintenance` | TIMESTAMP | Last maintenance timestamp |
| `neighborhood_id` | TEXT | Foreign key to neighborhoods table |
| `created_at` | TIMESTAMP | Record creation timestamp |
| `updated_at` | TIMESTAMP | Last update timestamp (auto-updated by trigger) |

**Spatial Type**: `GEOMETRY(Point, 4326)`

- **Point**: A single location defined by X (longitude) and Y (latitude) coordinates
- **SRID 4326**: Enables accurate distance calculations using geography casting

**Trigger**: `update_street_lights_updated_at` automatically updates `updated_at` on every row modification.

---

#### 3. `maintenance_requests`

Historical and active maintenance requests for street lights with free-text descriptions.

| Column | Type | Description |
|--------|------|-------------|
| `request_id` | TEXT | Primary key, unique identifier (e.g., "REQ-0001") |
| `light_id` | TEXT | Foreign key to street_lights table |
| `reported_at` | TIMESTAMP | When issue was reported |
| `resolved_at` | TIMESTAMP | When issue was resolved (NULL if still open) |
| `issue_type` | TEXT | Structured category: "bulb_failure", "wiring", "pole_damage", "power_supply", "sensor_failure" |
| `description` | TEXT | Free-text field report (e.g., "Light flickering on and off throughout the night...") |
| `created_at` | TIMESTAMP | Record creation timestamp |

---

#### 4. `suppliers`

Light equipment suppliers and their service coverage areas.

| Column | Type | Description |
|--------|------|-------------|
| `supplier_id` | TEXT | Primary key, unique identifier (e.g., "SUP-001") |
| `name` | TEXT | Supplier company name |
| `location` | GEOMETRY(Point, 4326) | Supplier office GPS coordinates |
| `contact_phone` | TEXT | Contact phone number |
| `service_radius_km` | INTEGER | Maximum service coverage radius in kilometers |
| `avg_response_hours` | INTEGER | Average response time in hours |
| `specialization` | TEXT | Specialization: 'LED', 'Sodium Vapor', or 'All' |
| `created_at` | TIMESTAMP | Record creation timestamp |

---

### Enrichment Tables (Contextual Data)

These tables store contextual data that enriches the operational data for analytics and ML predictions.

#### 5. `weather_enrichment`

Seasonal weather patterns affecting light failure rates.

| Column | Type | Description |
|--------|------|-------------|
| `light_id` | TEXT | Foreign key to street_lights (part of composite PK) |
| `season` | TEXT | Season: 'monsoon' (Jun-Sep), 'summer' (Mar-May), 'winter' (Dec-Feb) |
| `avg_temperature_c` | NUMERIC(5,2) | Average temperature in Celsius (e.g., 28.50) |
| `rainfall_mm` | NUMERIC(6,2) | Average rainfall in millimeters (e.g., 250.75) |
| `failure_risk_score` | NUMERIC(3,2) | Predicted failure risk: 0.0 (low) to 1.0 (high) |
| `predicted_failure_date` | DATE | ML-predicted failure date |
| `created_at` | TIMESTAMP | Record creation timestamp |

**Primary Key**: Composite key (`light_id`, `season`) - each light has 3 records (one per season)

---

#### 6. `demographics_enrichment`

Neighborhood characteristics for resource planning and prioritization.

| Column | Type | Description |
|--------|------|-------------|
| `neighborhood_id` | TEXT | Primary key, foreign key to neighborhoods |
| `population_density` | INTEGER | People per square kilometer |
| `urban_classification` | TEXT | Development level: 'urban', 'suburban', or 'rural' |
| `created_at` | TIMESTAMP | Record creation timestamp |

---

#### 7. `power_grid_enrichment`

Electrical infrastructure context for each light.

| Column | Type | Description |
|--------|------|-------------|
| `light_id` | TEXT | Primary key, foreign key to street_lights |
| `grid_zone` | TEXT | Power grid zone identifier (e.g., "ZONE-A", "ZONE-B") |
| `avg_load_percent` | NUMERIC(5,2) | Average grid load percentage (0-100) |
| `outage_history_count` | INTEGER | Number of historical power outages |
| `created_at` | TIMESTAMP | Record creation timestamp |

---

## üìä Enriched Views

Views combine base tables with enrichment data for analytics and CDC capture.

### `street_lights_enriched`

**Purpose**: Main view for analytics and CDC - combines lights with all contextual data for the current season.

**Columns Include**:

- All base light data (`light_id`, `location`, `status`, `wattage`, etc.)
- Extracted coordinates: `longitude` (ST_X), `latitude` (ST_Y)
- Neighborhood info (`neighborhood_name`, `population`)
- Current season weather data (`season`, `avg_temperature_c`, `failure_risk_score`, etc.)
- Demographics (`population_density`, `urban_classification`)
- Power grid data (`grid_zone`, `avg_load_percent`, `outage_history_count`)
- Calculated fields:
  - `age_months`: Light age in months
  - `days_since_maintenance`: Days since last maintenance
  - `maintenance_urgency`: CRITICAL, HIGH, MEDIUM, or LOW (based on predicted failure date)

**Season Detection**: Automatically joins weather data for the current season:

- Monsoon: June - September (months 6-9)
- Summer: March - May (months 3-5)
- Winter: December - February (months 12, 1-2)

---

### `maintenance_requests_enriched`

**Purpose**: Maintenance requests with spatial and enrichment context.

**Columns Include**:

- All maintenance request data
- Light location (`location`, `longitude`, `latitude`)
- Neighborhood info
- Weather context at time of report
- Calculated fields:
  - `resolution_hours`: Time to resolve (NULL if still open)
  - `status`: 'OPEN' or 'CLOSED'

---

## üîß Functions

### `get_nearest_supplier(light_id TEXT)`

**Purpose**: Find the nearest supplier to a specific light using PostGIS KNN operator.

**Returns**:

- `supplier_id`, `supplier_name`, `distance_km`, `contact_phone`, `avg_response_hours`, `specialization`

**Example Usage**:

```sql
SELECT * FROM get_nearest_supplier('LIGHT-0001');
```

---

## üìê PostGIS Data Types & Functions

### Geometry Types

#### `GEOMETRY(Point, 4326)`

- Represents a single location (X, Y coordinates)
- SRID 4326 = WGS84 (standard GPS coordinates)
- Example: `POINT(77.5946 12.9716)` (longitude, latitude)

#### `GEOMETRY(Polygon, 4326)`

- Represents a closed area defined by a series of points
- Used for neighborhood boundaries
- Example: `POLYGON((lon1 lat1, lon2 lat2, lon3 lat3, lon1 lat1))`

### Common PostGIS Functions

#### Coordinate Extraction

- **`ST_X(geometry)`**: Extract longitude (X coordinate) from a point
- **`ST_Y(geometry)`**: Extract latitude (Y coordinate) from a point

#### Distance & Proximity

- **`ST_Distance(geog1, geog2)`**: Calculate distance in meters between two geographies
  - Note: Cast geometry to geography for accurate meter-based distances
  - Example: `ST_Distance(location::geography, other_location::geography)`
  
- **`ST_DWithin(geog1, geog2, distance_meters)`**: Check if two locations are within a specific distance
  - Example: `ST_DWithin(location::geography, center::geography, 1000)` (within 1km)

#### Containment

- **`ST_Within(point, polygon)`**: Check if a point is inside a polygon
  - Example: `ST_Within(light.location, neighborhood.boundary)`

#### KNN (K-Nearest Neighbors)

- **`<->` operator**: Distance operator for finding nearest objects
  - Example: `ORDER BY location <-> target_location LIMIT 5` (find 5 nearest)
  - Much faster than ST_Distance for simple nearest-neighbor queries

### Geography vs Geometry

**Geometry** (default):

- Works in Cartesian (flat) coordinate system
- Distances in "degrees" (not accurate for real-world distances)
- Fast for simple operations

**Geography** (cast with `::geography`):

- Works on a spherical Earth model
- Distances in meters (accurate for real-world calculations)
- Slightly slower but more accurate
- **Use for**: Distance calculations, radius searches

**Example**:

```sql
-- Geometry distance (in degrees - not useful)
SELECT ST_Distance(location, other_location) FROM street_lights;

-- Geography distance (in meters - accurate)
SELECT ST_Distance(location::geography, other_location::geography) FROM street_lights;
```

---

## üöÄ Indexes

### Spatial Indexes (GIST)

GIST (Generalized Search Tree) indexes enable fast spatial queries.

| Index | Table | Purpose |
|-------|-------|---------|
| `idx_lights_location` | street_lights | Fast proximity and containment queries |
| `idx_neighborhoods_boundary` | neighborhoods | Fast point-in-polygon queries |
| `idx_suppliers_location` | suppliers | Fast nearest supplier queries |

**Benefits**:

- Sub-second queries for `ST_Within`, `ST_DWithin`, `ST_Distance`
- Enables KNN (<->) operator optimization
- Critical for performance at scale

### B-tree Indexes

Standard indexes for foreign keys and common filters.

| Index | Table | Purpose |
|-------|-------|---------|
| `idx_lights_status` | street_lights | Fast filtering by status |
| `idx_lights_neighborhood` | street_lights | Fast JOINs with neighborhoods |
| `idx_maintenance_light` | maintenance_requests | Fast JOINs with street_lights |
| `idx_maintenance_reported` | maintenance_requests | Fast filtering by date |
| `idx_weather_light` | weather_enrichment | Fast enrichment JOINs |
| `idx_weather_season` | weather_enrichment | Fast seasonal filtering |
| `idx_power_grid_light` | power_grid_enrichment | Fast enrichment JOINs |

---

## üîÑ CDC (Change Data Capture) Configuration

### Write-Ahead Logging (WAL)

**Script**: `02_enable_wal.sql`

**Settings**:

- `wal_level = 'logical'`: Enables logical replication for CDC
- `max_replication_slots = 10`: Maximum number of CDC consumers
- `max_wal_senders = 10`: Maximum concurrent WAL streaming connections

> [!NOTE]
> These settings require PostgreSQL restart to take effect.

### Replication Slot

**Script**: `07_create_replication_slots.sql`

**Slot Name**: `snowflake_cdc_slot`

**Purpose**: Captures all changes to the database for streaming to Snowflake via Openflow.

**Plugin**: `pgoutput` (PostgreSQL's built-in logical replication output plugin)

---

## üß™ Testing the Schema

### Verify PostGIS Installation

```sql
SELECT PostGIS_Version();
```

### Check Tables

```sql
-- List all tables
\dt

-- Count records (after data load)
SELECT COUNT(*) FROM street_lights;
SELECT COUNT(*) FROM neighborhoods;
SELECT COUNT(*) FROM suppliers;
```

### Test Spatial Queries

```sql
-- Find lights within 1km of a point
SELECT light_id, status, 
       ST_Distance(location::geography, ST_MakePoint(77.5946, 12.9716)::geography) as distance_m
FROM street_lights
WHERE ST_DWithin(location::geography, ST_MakePoint(77.5946, 12.9716)::geography, 1000)
LIMIT 10;

-- Find lights in a neighborhood
SELECT l.light_id, l.status, n.name
FROM street_lights l
JOIN neighborhoods n ON ST_Within(l.location, n.boundary)
WHERE n.name = 'Koramangala';
```

### Test Enriched View

```sql
-- Query enriched data
SELECT light_id, status, neighborhood_name, season, 
       failure_risk_score, maintenance_urgency
FROM street_lights_enriched
WHERE failure_risk_score > 0.7
ORDER BY predicted_failure_date
LIMIT 10;
```

### Test Nearest Supplier Function

```sql
-- Find nearest supplier for a light
SELECT * FROM get_nearest_supplier('LIGHT-0001');
```

---

## üìñ Learning Resources

### PostGIS Documentation

- [PostGIS Official Documentation](https://postgis.net/documentation/)
- [PostGIS Intro Workshop](https://postgis.net/workshops/postgis-intro/)
- [Spatial Reference Systems](https://spatialreference.org/ref/epsg/4326/)

### Key Concepts

- **SRID**: Spatial Reference System Identifier (4326 = WGS84 GPS coordinates)
- **WGS84**: World Geodetic System 1984 - standard for GPS
- **GIST Index**: Generalized Search Tree for spatial data
- **KNN**: K-Nearest Neighbors algorithm for proximity searches
- **CDC**: Change Data Capture for real-time data streaming

---

## üêõ Troubleshooting

### PostGIS Extension Not Found

```sql
-- Check if PostGIS is installed
SELECT * FROM pg_available_extensions WHERE name LIKE 'postgis%';

-- Verify PostGIS version
SELECT PostGIS_Version();
```

### WAL Level Not Logical

```sql
-- Check current WAL level
SELECT name, setting FROM pg_settings WHERE name = 'wal_level';

-- If not 'logical', restart PostgreSQL
docker-compose restart postgres
```

### Replication Slot Not Created

```sql
-- List replication slots
SELECT * FROM pg_replication_slots;

-- Create manually if needed
SELECT pg_create_logical_replication_slot('snowflake_cdc_slot', 'pgoutput');
```

### Spatial Query Performance Issues

```sql
-- Check if spatial indexes exist
SELECT tablename, indexname FROM pg_indexes 
WHERE indexname LIKE 'idx_%location%' OR indexname LIKE 'idx_%boundary%';

-- Rebuild index if needed
REINDEX INDEX idx_lights_location;
```

---

## üìù Notes

1. **Automatic Execution**: These scripts run automatically when the PostgreSQL container starts for the first time via Docker's entrypoint mechanism (`/docker-entrypoint-initdb.d/`).

2. **Idempotency**: Most scripts use `IF NOT EXISTS` to safely re-run without errors.

3. **Data Loading**: After initialization, load data using:

   ```bash
   docker exec -it streetlights-postgres psql -U postgres -d streetlights -f /data/load_data.sql
   ```

4. **CDC**: Change Data Capture is configured for Snowflake Openflow (not Apache NiFi).

5. **Performance**: With proper indexes, spatial queries on 5,000+ lights return results in milliseconds.

---

**Built with ‚ù§Ô∏è for spatial data education**
